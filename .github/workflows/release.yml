# This is a basic workflow to help you get started with Actions

name: release

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  # push:
  #   branches: [main]
  # pull_request:
  #   branches: [main]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:

  android:
    uses: derqurps/noefinderlein_flutter/.github/workflows/android_build.yml@main
    secrets: inherit

  macos:
    uses: derqurps/noefinderlein_flutter/.github/workflows/macos_build.yml@main
    secrets: inherit

  ios:
    uses: derqurps/noefinderlein_flutter/.github/workflows/ios_build.yml@main
    secrets: inherit

  # web:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: "2.13.0-0.4.pre"
  #         channel: "beta"
  #     - run: flutter upgrade
  #     - run: flutter pub get
  #     - run: flutter test
  #     - run: flutter build web

  windows:
    uses: derqurps/noefinderlein_flutter/.github/workflows/windows_build.yml@main
    secrets: inherit

  linux:
    uses: derqurps/noefinderlein_flutter/.github/workflows/linux_build.yml@main
    secrets: inherit

  deploy:
    needs: [android, macos, ios, windows, linux]
    runs-on: ubuntu-latest
    steps:
      - name: Get the version
        id: get_version
        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
      - uses: actions/download-artifact@v3
        with:
          name: android
          path: android
      - name: Display structure of downloaded files
        run: ls -R
        working-directory: android
      - uses: actions/download-artifact@v3
        with:
          name: macos
          path: macos
      - name: Display structure of downloaded files
        run: ls -R
        working-directory: macos
      - uses: actions/download-artifact@v3
        with:
          name: ios
          path: ios
      - name: Display structure of downloaded files
        run: ls -R
        working-directory: ios
      - uses: actions/download-artifact@v3
        with:
          name: windows
          path: windows
      - name: Display structure of downloaded files
        run: ls -R
        working-directory: windows
      - uses: actions/download-artifact@v3
        with:
          name: appimage
          path: appimage
      - uses: actions/download-artifact@v3
        with:
          name: tgz
          path: tgz
      - name: Display structure of downloaded files
        run: ls -R
        working-directory: appimage
      - uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "${{ steps.get_version.outputs.VERSION }}"
          prerelease: false
          title: "NÃ– Finderlein Release ${{ steps.get_version.outputs.VERSION }}"
          files: |
            android/**/*.apk
            android/**/*.aab
            macos/**/*.dmg
            macos/*.dmg
            ios/**/*.app
            ios/**/*.app.
            ios/*.app
            ios/*.app.
            windows/**/*.zip
            windows/*.zip
            appimage/*.AppImage
            tgz/*.tgz
